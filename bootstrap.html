<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">

<div class="container-fluid p-4">

    <!-- Filter Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-body d-flex align-items-center justify-content-between" style="height: 6rem;">
            <div class="d-flex align-items-center h-100 w-50">
                <h2 class="h5 mb-0">Filters</h2>
                <div class="vr mx-4"></div>
                <div id="selected-filters-container" class="flex-grow-1 overflow-auto text-nowrap py-1 pe-4">
                    <span class="text-muted small">No filters applied</span>
                    <!-- Badges will be dynamically inserted here -->
                </div>
            </div>

            <div class="d-flex align-items-center h-100">
                <div class="vr mx-4"></div>
                <div class="d-flex align-items-center gap-4">
                    <!-- Model Dropdown -->
                    <div class="dropdown">
                        <button id="model-dropdown-button" class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Model
                        </button>
                        <div id="model-dropdown" class="dropdown-menu p-3" style="width: 280px; z-index: 1030;">
                            <div class="mb-3">
                                <label for="model-search" class="visually-hidden">Search</label>
                                <input type="text" id="model-search" class="form-control" placeholder="Search model">
                            </div>
                            <ul class="list-unstyled overflow-auto" style="max-height: 200px;" aria-labelledby="model-dropdown-button">
                                <li>
                                    <label class="dropdown-item">
                                        <input class="form-check-input me-2" type="checkbox" value="Toyota" id="checkbox-item-1">
                                        Toyota
                                    </label>
                                </li>
                                <li>
                                    <label class="dropdown-item">
                                        <input class="form-check-input me-2" type="checkbox" value="Honda" id="checkbox-item-2">
                                        Honda
                                    </label>
                                </li>
                                <li>
                                    <label class="dropdown-item">
                                        <input class="form-check-input me-2" type="checkbox" value="Ford" id="checkbox-item-3">
                                        Ford
                                    </label>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Year Dropdown -->
                    <div class="dropdown">
                        <button id="year-dropdown-button" class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Min Year
                        </button>
                        <ul id="year-dropdown" class="dropdown-menu" aria-labelledby="year-dropdown-button" style="z-index: 1030;">
                            <!-- Years will be dynamically inserted here by JavaScript -->
                        </ul>
                    </div>

                    <!-- Min Price Dropdown -->
                    <div class="dropdown">
                        <button id="min-price-dropdown-button" class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Min Price
                        </button>
                        <ul id="min-price-dropdown" class="dropdown-menu" aria-labelledby="min-price-dropdown-button" style="z-index: 1030;">
                            <!-- Options will be dynamically inserted here -->
                        </ul>
                    </div>

                    <!-- Max Price Dropdown -->
                    <div class="dropdown">
                        <button id="max-price-dropdown-button" class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Max Price
                        </button>
                        <ul id="max-price-dropdown" class="dropdown-menu" aria-labelledby="max-price-dropdown-button" style="z-index: 1030;">
                            <!-- Options will be dynamically inserted here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <img src="https://via.placeholder.com/800x400.png?text=Chart+Placeholder+1" alt="Chart 1" class="img-fluid rounded">
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <img src="https://via.placeholder.com/800x400.png?text=Chart+Placeholder+2" alt="Chart 2" class="img-fluid rounded">
            </div>
        </div>
    </div>


    <!-- Table Section -->
    <div class="card shadow-sm" style="flex-grow: 3; overflow: hidden; position: relative;">
        <div class="overflow-auto h-100">
            <table id="data-table" class="table table-striped table-hover">
                <thead class="table-light sticky-top">
                    <tr>
                        <th scope="col" class="px-3 py-2" style="cursor: pointer;">listingId</th>
                        <th scope="col" class="px-3 py-2" style="cursor: pointer;">make</th>
                        <th scope="col" class="px-3 py-2" style="cursor: pointer;">model</th>
                        <th scope="col" class="px-3 py-2" style="cursor: pointer;">year</th>
                        <th scope="col" class="px-3 py-2" style="cursor: pointer;">price</th>
                        <th scope="col" class="px-3 py-2">detailPageUrl</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // -------------------------------------------------------------------------
    // --- 1. STATE MANAGEMENT & INITIALIZATION ---
    // -------------------------------------------------------------------------

    // Central object to hold all active filters
    const filters = {
        models: new Set(),
        year: null,
        price: { min: null, max: null }
    };

    // Store the original dataset and the current sort state
    let tableData = [];
    let sortState = {};

    // DOM element references
    const tableBody = document.querySelector('#data-table tbody');
    const badgesContainer = document.getElementById('selected-filters-container');
    const yearDropdown = document.getElementById('year-dropdown');
    const minPriceDropdown = document.getElementById('min-price-dropdown');
    const maxPriceDropdown = document.getElementById('max-price-dropdown');


    // -------------------------------------------------------------------------
    // --- 2. CORE LOGIC (DATA HANDLING & FILTERING) ---
    // -------------------------------------------------------------------------

    /**
     * Applies all active filters from the 'filters' object to the master 'tableData'
     * and re-renders the table.
     */
    const applyFilters = () => {
        let filteredData = [...tableData];

        // Apply model filter
        if (filters.models.size > 0) {
            filteredData = filteredData.filter(item => filters.models.has(item.make));
        }

        // Apply minimum year filter
        if (filters.year) {
            filteredData = filteredData.filter(item => item.year >= filters.year);
        }

        // Apply minimum price filter
        if (filters.price.min) {
            filteredData = filteredData.filter(item => item.price >= filters.price.min);
        }

        // Apply maximum price filter
        if (filters.price.max) {
            filteredData = filteredData.filter(item => item.price <= filters.price.max);
        }

        renderTable(filteredData);
        updateBadges();
    };

    /**
     * Generates an array of dummy data for the table.
     * @param {number} count - The number of rows to generate.
     * @returns {Array<Object>}
     */
    const generateDummyData = (count) => {
        const data = [];
        const makes = ['Toyota', 'Honda', 'Ford'];
        for (let i = 1; i <= count; i++) {
            const make = makes[Math.floor(Math.random() * makes.length)];
            data.push({
                listingId: `ID-${1000 + i}`,
                make: make,
                model: `${make} Model ${i}`,
                year: 2015 + Math.floor(Math.random() * 11),
                price: 5000 + Math.floor(Math.random() * 25000),
                detailPageUrl: `https://example.com/listing/${1000 + i}`
            });
        }
        return data;
    };


    // -------------------------------------------------------------------------
    // --- 3. UI RENDERING FUNCTIONS ---
    // -------------------------------------------------------------------------

    /**
     * Clears and re-renders the table body with the provided data.
     * @param {Array<Object>} data - The data to display in the table.
     */
    const renderTable = (data) => {
        tableBody.innerHTML = '';
        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-3 py-2">${row.listingId}</td>
                <td class="px-3 py-2">${row.make}</td>
                <td class="px-3 py-2">${row.model}</td>
                <td class="px-3 py-2">${row.year}</td>
                <td class="px-3 py-2">$${row.price.toLocaleString()}</td>
                <td class="px-3 py-2"><a href="${row.detailPageUrl}" target="_blank">View</a></td>
            `;
            tableBody.appendChild(tr);
        });
    };

    /**
     * Updates the filter badges display based on the current state of the 'filters' object.
     */
    const updateBadges = () => {
        badgesContainer.innerHTML = '';
        let hasFilters = false;

        // Model badges
        filters.models.forEach(model => {
            hasFilters = true;
            const badge = createBadge(`Model: ${model}`, () => {
                filters.models.delete(model);
                document.querySelector(`#model-dropdown input[value="${model}"]`).checked = false;
                applyFilters();
            });
            badgesContainer.appendChild(badge);
        });
        
        // Year badge
        if (filters.year) {
            hasFilters = true;
            const badge = createBadge(`Min Year: ${filters.year}`, () => {
                filters.year = null;
                applyFilters();
            });
            badgesContainer.appendChild(badge);
        }
        
        // Min price badge
        if (filters.price.min) {
            hasFilters = true;
            const badge = createBadge(`Min Price: $${filters.price.min.toLocaleString()}`, () => {
                filters.price.min = null;
                applyFilters();
            });
            badgesContainer.appendChild(badge);
        }

        // Max price badge
        if (filters.price.max) {
            hasFilters = true;
            const badge = createBadge(`Max Price: $${filters.price.max.toLocaleString()}`, () => {
                filters.price.max = null;
                applyFilters();
            });
            badgesContainer.appendChild(badge);
        }

        // Display placeholder text if no filters are active
        if (!hasFilters) {
            badgesContainer.innerHTML = '<span class="text-muted small">No filters applied</span>';
        }
    };

    /**
     * Creates a Bootstrap badge component.
     * @param {string} text - The text to display in the badge.
     * @param {Function} removeCallback - The function to call when the badge's close button is clicked.
     * @returns {HTMLElement}
     */
    const createBadge = (text, removeCallback) => {
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary me-2';
        badge.innerHTML = `${text} <button type="button" class="btn-close btn-close-white ms-2" aria-label="Close"></button>`;
        badge.querySelector('button').onclick = removeCallback;
        return badge;
    };


    // -------------------------------------------------------------------------
    // --- 4. DYNAMIC FILTER POPULATION ---
    // -------------------------------------------------------------------------

    /**
     * Populates the Min Year dropdown with options from the current year down to 2015.
     */
    const populateYearFilter = () => {
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= 2015; year--) {
            const li = document.createElement('li');
            li.innerHTML = `<a class="dropdown-item" href="#" data-value="${year}">${year}</a>`;
            yearDropdown.appendChild(li);
        }
    };

    /**
     * Populates the Min and Max Price dropdowns with a predefined set of options.
     */
    const populatePriceFilters = () => {
        const priceOptions = [5000, 10000, 15000, 20000, 25000];
        priceOptions.forEach(price => {
            const optionHTML = `<li><a class="dropdown-item" href="#" data-value="${price}">$${price.toLocaleString()}</a></li>`;
            minPriceDropdown.innerHTML += optionHTML;
            maxPriceDropdown.innerHTML += optionHTML;
        });
    };


    // -------------------------------------------------------------------------
    // --- 5. EVENT LISTENERS ---
    // -------------------------------------------------------------------------

    /**
     * Attaches all necessary event listeners for user interaction.
     */
    const setupEventListeners = () => {

        // Dropdown Hover Functionality
        document.querySelectorAll('.dropdown').forEach(dropdownElement => {
            const dropdown = new bootstrap.Dropdown(dropdownElement.querySelector('.dropdown-toggle'));

            // Show dropdown on hover
            dropdownElement.addEventListener('mouseenter', () => {
                dropdown.show();
            });

            // Hide dropdown when mouse leaves
            dropdownElement.addEventListener('mouseleave', () => {
                dropdown.hide();
            });
        });

        // Table Header Sorting Listener
        document.querySelectorAll('#data-table thead th').forEach(header => {
            // Store the original header text in a data attribute for reference
            if (header.style.cursor === 'pointer') {
                header.setAttribute('data-original-text', header.textContent);
            
                header.addEventListener('click', () => {
                    // Use the original text as the key for sorting logic
                    const columnKey = header.getAttribute('data-original-text');
                    const currentDirection = sortState[columnKey] || 'desc';
                    const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                    sortState = { [columnKey]: newDirection };

                    // --- Visual Indicator Logic ---
                    // 1. Clear indicators from all other headers
                    document.querySelectorAll('#data-table thead th[data-original-text]').forEach(th => {
                        th.textContent = th.getAttribute('data-original-text');
                    });

                    // 2. Add the new indicator to the clicked header
                    header.textContent = `${columnKey} ${newDirection === 'asc' ? '▲' : '▼'}`;
                    // --- End of Visual Indicator Logic ---

                    // Sort the data
                    const sortedData = [...tableData].sort((a, b) => {
                        if (a[columnKey] < b[columnKey]) return newDirection === 'asc' ? -1 : 1;
                        if (a[columnKey] > b[columnKey]) return newDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                    
                    renderTable(sortedData);
                });
            }
        });

        // Model Filter Checkbox Listeners
        document.querySelectorAll('#model-dropdown input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                if (e.target.checked) filters.models.add(e.target.value);
                else filters.models.delete(e.target.value);
                applyFilters();
            });
        });

        // Model Filter Search Input Listener
        document.getElementById('model-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#model-dropdown ul li').forEach(li => {
                const label = li.querySelector('label').textContent.toLowerCase();
                li.style.display = label.includes(searchTerm) ? '' : 'none';
            });
        });

        // Year Filter Dropdown Listener
        yearDropdown.addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.matches('a.dropdown-item')) {
                filters.year = Number(e.target.getAttribute('data-value'));
                applyFilters();
            }
        });
        
        // Min Price Filter Dropdown Listener
        minPriceDropdown.addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.matches('a.dropdown-item')) {
                filters.price.min = Number(e.target.getAttribute('data-value'));
                applyFilters();
            }
        });

        // Max Price Filter Dropdown Listener
        maxPriceDropdown.addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.matches('a.dropdown-item')) {
                filters.price.max = Number(e.target.getAttribute('data-value'));
                applyFilters();
            }
        });
    };


    // -------------------------------------------------------------------------
    // --- 6. INITIAL PAGE LOAD ---
    // -------------------------------------------------------------------------
    
    // Dynamically populate filter options
    populateYearFilter();
    populatePriceFilters();
    
    // Attach all event listeners
    setupEventListeners();

    // Generate initial data and render the table
    tableData = generateDummyData(50); // Increased count for better testing
    renderTable(tableData);
});
</script>

</body>
</html>