<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Price vs Mileage Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.4;
        }
        .point {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="chart"></div>

    <script>
        // Wait for all D3 components to load
        document.addEventListener('DOMContentLoaded', function() {
            // Set the dimensions and margins of the graph
            const margin = {top: 40, right: 40, bottom: 60, left: 70};
            const width = 800 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

        // Create the SVG container
        const svg = d3.select("#chart")
            .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create tooltip div
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Load and process the data
        fetch('Car_202509222105.json')
            .then(response => response.json())
            .then(data => {
                const cars = data.Car;

                // Create scales
                const x = d3.scaleLinear()
                    .domain([0, d3.max(cars, d => d.mileage)])
                    .range([0, width]);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(cars, d => d.price)])
                    .range([height, 0]);

                // Create data for polynomial regression
                const curveData = [];
                
                // Get x and y values
                const xValues = cars.map(d => d.mileage);
                const yValues = cars.map(d => d.price);
                
                // Helper function for polynomial regression
                function polynomialRegression(x, y, degree) {
                    const n = x.length;
                    let xMatrix = [];
                    let yMatrix = y.map(v => [v]);
                    
                    // Build the X matrix
                    for(let i = 0; i < n; i++) {
                        let row = [];
                        for(let j = 0; j <= degree; j++) {
                            row.push(Math.pow(x[i], j));
                        }
                        xMatrix.push(row);
                    }
                    
                    // Helper function for matrix multiplication
                    function multiply(a, b) {
                        return a.map(row => 
                            b[0].map((_, i) => 
                                row.reduce((sum, elem, j) => 
                                    sum + elem * b[j][i], 0
                                )
                            )
                        );
                    }
                    
                    // Helper function for matrix transpose
                    function transpose(matrix) {
                        return matrix[0].map((_, i) => 
                            matrix.map(row => row[i])
                        );
                    }
                    
                    // Calculate coefficients using normal equation
                    const xTranspose = transpose(xMatrix);
                    const xTx = multiply(xTranspose, xMatrix);
                    const xTy = multiply(xTranspose, yMatrix);
                    
                    // Solve for coefficients
                    const coefficients = multiply(
                        inverse(xTx),
                        xTy
                    ).map(row => row[0]);
                    
                    return coefficients;
                }
                
                // Helper function for matrix inverse (simplified for small matrices)
                function inverse(matrix) {
                    const n = matrix.length;
                    let result = Array(n).fill().map(() => Array(n).fill(0));
                    let temp = matrix.map((row, i) => [...row, ...(Array(n).fill().map((_, j) => i === j ? 1 : 0))]);
                    
                    // Gaussian elimination
                    for(let i = 0; i < n; i++) {
                        let pivot = temp[i][i];
                        for(let j = 0; j < 2 * n; j++) {
                            temp[i][j] /= pivot;
                        }
                        for(let k = 0; k < n; k++) {
                            if(k !== i) {
                                let factor = temp[k][i];
                                for(let j = 0; j < 2 * n; j++) {
                                    temp[k][j] -= factor * temp[i][j];
                                }
                            }
                        }
                    }
                    
                    for(let i = 0; i < n; i++) {
                        for(let j = 0; j < n; j++) {
                            result[i][j] = temp[i][j + n];
                        }
                    }
                    
                    return result;
                }
                
                // Calculate polynomial coefficients (3rd degree)
                const coefficients = polynomialRegression(xValues, yValues, 3);
                
                // Generate points for the curve
                const numPoints = 100;
                const xMin = d3.min(xValues);
                const xMax = d3.max(xValues);
                const xStep = (xMax - xMin) / (numPoints - 1);
                
                for(let i = 0; i < numPoints; i++) {
                    const x = xMin + i * xStep;
                    let y = 0;
                    for(let j = 0; j < coefficients.length; j++) {
                        y += coefficients[j] * Math.pow(x, j);
                    }
                    curveData.push([x, y]);
                }

                console.log('Polynomial coefficients:', coefficients);
                console.log('Curve data points:', curveData.length);

                // Add X axis
                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x))
                    .append("text")
                    .attr("x", width / 2)
                    .attr("y", 40)
                    .attr("fill", "black")
                    .style("text-anchor", "middle")
                    .text("Mileage (km)");

                // Add Y axis
                svg.append("g")
                    .call(d3.axisLeft(y))
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -50)
                    .attr("x", -(height / 2))
                    .attr("fill", "black")
                    .style("text-anchor", "middle")
                    .text("Price (AED)");

                // Add dots
                svg.selectAll("circle")
                    .data(cars)
                    .join("circle")
                        .attr("class", "point")
                        .attr("cx", d => x(d.mileage))
                        .attr("cy", d => y(d.price))
                        .attr("r", 6)
                        .style("fill", "#69b3a2")
                        .on("mouseover", function(event, d) {
                            d3.select(this)
                                .transition()
                                .duration(200)
                                .style("fill", "#003f5c");

                            tooltip.transition()
                                .duration(200)
                                .style("opacity", .9);

                            tooltip.html(
                                `Title: ${d.title}<br/>
                                Price: ${d.price} AED<br/>
                                Mileage: ${d.mileage} km<br/>
                                Year: ${d.year}<br/>
                                Spec: ${d.spec}`
                            )
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", function() {
                            d3.select(this)
                                .transition()
                                .duration(200)
                                .style("fill", "#69b3a2");

                            tooltip.transition()
                                .duration(500)
                                .style("opacity", 0);
                        })
                        .on("click", function(event, d) {
                            window.open(d.detailPageUrl, '_blank');
                        });

                // Calculate moving average curve
                const movingAverageData = [];
                const sortedForMA = [...cars].sort((a, b) => a.mileage - b.mileage);
                const windowSize = 5;
                const maPoints = 50;
                
                for (let i = 0; i < maPoints; i++) {
                    const t = i / (maPoints - 1);
                    const index = Math.floor(t * (sortedForMA.length - 1));
                    const start = Math.max(0, index - windowSize);
                    const end = Math.min(sortedForMA.length - 1, index + windowSize);
                    const window = sortedForMA.slice(start, end + 1);
                    const avgMileage = d3.mean(window, d => d.mileage);
                    const avgPrice = d3.mean(window, d => d.price);
                    movingAverageData.push([avgMileage, avgPrice]);
                }

                // Create line generator
                const line = d3.line()
                    .x(d => x(d[0]))
                    .y(d => y(d[1]))
                    .curve(d3.curveBasis);

                // Draw the polynomial regression curve
                svg.append("path")
                    .datum(curveData)
                    .attr("class", "polynomial")
                    .attr("fill", "none")
                    .attr("stroke", "red")
                    .attr("stroke-width", 2.5)
                    .attr("stroke-dasharray", "5,5")
                    .attr("d", line)
                    .style("opacity", 0.7);

                // Draw the moving average curve
                svg.append("path")
                    .datum(movingAverageData)
                    .attr("class", "moving-average")
                    .attr("fill", "none")
                    .attr("stroke", "blue")
                    .attr("stroke-width", 2.5)
                    .attr("d", line)
                    .style("opacity", 0.7);

                // Add legend
                const legend = svg.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(${width - 200}, 20)`);

                // Polynomial regression legend item
                legend.append("line")
                    .attr("x1", 0)
                    .attr("x2", 20)
                    .attr("y1", 0)
                    .attr("y2", 0)
                    .attr("stroke", "red")
                    .attr("stroke-width", 2.5)
                    .attr("stroke-dasharray", "5,5");

                legend.append("text")
                    .attr("x", 25)
                    .attr("y", 4)
                    .text("Polynomial Regression")
                    .style("font-size", "12px");

                // Moving average legend item
                legend.append("line")
                    .attr("x1", 0)
                    .attr("x2", 20)
                    .attr("y1", 20)
                    .attr("y2", 20)
                    .attr("stroke", "blue")
                    .attr("stroke-width", 2.5);

                legend.append("text")
                    .attr("x", 25)
                    .attr("y", 24)
                    .text("Moving Average")
                    .style("font-size", "12px");

                // Add title
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", -margin.top / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "16px")
                    .style("font-weight", "bold")
                    .text("Car Price vs Mileage");
            })
            .catch(error => console.error('Error loading the data:', error));
        });
    </script>
</body>
</html>
