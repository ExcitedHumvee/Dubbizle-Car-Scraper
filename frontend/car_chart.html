<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Price vs Mileage Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.4;
        }
        .point {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="chart"></div>

    <script>
        // Wait for all D3 components to load
        document.addEventListener('DOMContentLoaded', function() {
            // Set the dimensions and margins of the graph
            const margin = {top: 40, right: 40, bottom: 60, left: 70};
            const width = 800 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

        // Create the SVG container
        const svg = d3.select("#chart")
            .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create tooltip div
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Load and process the data
        fetch('Car_202509222105.json')
            .then(response => response.json())
            .then(data => {
                const cars = data.Car;

                // Create scales
                const x = d3.scaleLinear()
                    .domain([0, d3.max(cars, d => d.mileage)])
                    .range([0, width]);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(cars, d => d.price)])
                    .range([height, 0]);

                // Create data for polynomial regression
                const curveData = [];
                
                // Get x and y values
                const xValues = cars.map(d => d.mileage);
                const yValues = cars.map(d => d.price);
                
                // Helper function for polynomial regression
                function polynomialRegression(x, y, degree) {
                    const n = x.length;
                    let xMatrix = [];
                    let yMatrix = y.map(v => [v]);
                    
                    // Build the X matrix
                    for(let i = 0; i < n; i++) {
                        let row = [];
                        for(let j = 0; j <= degree; j++) {
                            row.push(Math.pow(x[i], j));
                        }
                        xMatrix.push(row);
                    }
                    
                    // Helper function for matrix multiplication
                    function multiply(a, b) {
                        return a.map(row => 
                            b[0].map((_, i) => 
                                row.reduce((sum, elem, j) => 
                                    sum + elem * b[j][i], 0
                                )
                            )
                        );
                    }
                    
                    // Helper function for matrix transpose
                    function transpose(matrix) {
                        return matrix[0].map((_, i) => 
                            matrix.map(row => row[i])
                        );
                    }
                    
                    // Calculate coefficients using normal equation
                    const xTranspose = transpose(xMatrix);
                    const xTx = multiply(xTranspose, xMatrix);
                    const xTy = multiply(xTranspose, yMatrix);
                    
                    // Solve for coefficients
                    const coefficients = multiply(
                        inverse(xTx),
                        xTy
                    ).map(row => row[0]);
                    
                    return coefficients;
                }
                
                // Helper function for matrix inverse (simplified for small matrices)
                function inverse(matrix) {
                    const n = matrix.length;
                    let result = Array(n).fill().map(() => Array(n).fill(0));
                    let temp = matrix.map((row, i) => [...row, ...(Array(n).fill().map((_, j) => i === j ? 1 : 0))]);
                    
                    // Gaussian elimination
                    for(let i = 0; i < n; i++) {
                        let pivot = temp[i][i];
                        for(let j = 0; j < 2 * n; j++) {
                            temp[i][j] /= pivot;
                        }
                        for(let k = 0; k < n; k++) {
                            if(k !== i) {
                                let factor = temp[k][i];
                                for(let j = 0; j < 2 * n; j++) {
                                    temp[k][j] -= factor * temp[i][j];
                                }
                            }
                        }
                    }
                    
                    for(let i = 0; i < n; i++) {
                        for(let j = 0; j < n; j++) {
                            result[i][j] = temp[i][j + n];
                        }
                    }
                    
                    return result;
                }
                
                // Calculate polynomial coefficients (3rd degree)
                const coefficients = polynomialRegression(xValues, yValues, 3);
                
                // Generate points for the polynomial curve
                for(let i = 0; i < 100; i++) {
                    const x = d3.min(xValues) + (i / 99) * (d3.max(xValues) - d3.min(xValues));
                    let y = 0;
                    for(let j = 0; j < coefficients.length; j++) {
                        y += coefficients[j] * Math.pow(x, j);
                    }
                    curveData.push([x, y]);
                }

                console.log('Polynomial coefficients:', coefficients);
                console.log('Curve data points:', curveData.length);

                // Add X axis
                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x))
                    .append("text")
                    .attr("x", width / 2)
                    .attr("y", 40)
                    .attr("fill", "black")
                    .style("text-anchor", "middle")
                    .text("Mileage (km)");

                // Add Y axis
                svg.append("g")
                    .call(d3.axisLeft(y))
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -50)
                    .attr("x", -(height / 2))
                    .attr("fill", "black")
                    .style("text-anchor", "middle")
                    .text("Price (AED)");

                // Add dots
                svg.selectAll("circle")
                    .data(cars)
                    .join("circle")
                        .attr("class", "point")
                        .attr("cx", d => x(d.mileage))
                        .attr("cy", d => y(d.price))
                        .attr("r", 6)
                        .style("fill", "#69b3a2")
                        .on("mouseover", function(event, d) {
                            d3.select(this)
                                .transition()
                                .duration(200)
                                .style("fill", "#003f5c");

                            tooltip.transition()
                                .duration(200)
                                .style("opacity", .9);

                            tooltip.html(
                                `Title: ${d.title}<br/>
                                Price: ${d.price} AED<br/>
                                Mileage: ${d.mileage} km<br/>
                                Year: ${d.year}<br/>
                                Spec: ${d.spec}`
                            )
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", function() {
                            d3.select(this)
                                .transition()
                                .duration(200)
                                .style("fill", "#69b3a2");

                            tooltip.transition()
                                .duration(500)
                                .style("opacity", 0);
                        })
                        .on("click", function(event, d) {
                            window.open(d.detailPageUrl, '_blank');
                        });

                // Calculate exponential regression
                const expRegression = () => {
                    const n = cars.length;
                    const xy = cars.map(d => Math.log(d.price) * d.mileage);
                    const x = cars.map(d => d.mileage);
                    const y = cars.map(d => Math.log(d.price));
                    const x2 = cars.map(d => d.mileage * d.mileage);
                    
                    const b = (n * d3.sum(xy) - d3.sum(x) * d3.sum(y)) / 
                            (n * d3.sum(x2) - d3.sum(x) * d3.sum(x));
                    const a = (d3.sum(y) - b * d3.sum(x)) / n;
                    
                    return [Math.exp(a), b]; // returns [a, b] for y = ae^(bx)
                };

                // Calculate power regression
                const powerRegression = () => {
                    // Filter out any zero or negative values
                    const validData = cars.filter(d => d.mileage > 0 && d.price > 0);
                    
                    const n = validData.length;
                    // Take logs of valid data only
                    const xy = validData.map(d => Math.log(d.mileage) * Math.log(d.price));
                    const x = validData.map(d => Math.log(d.mileage));
                    const y = validData.map(d => Math.log(d.price));
                    const x2 = validData.map(d => Math.log(d.mileage) * Math.log(d.mileage));
                    
                    const sumXY = d3.sum(xy);
                    const sumX = d3.sum(x);
                    const sumY = d3.sum(y);
                    const sumX2 = d3.sum(x2);
                    
                    const b = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                    const a = Math.exp((sumY - b * sumX) / n);
                    
                    console.log('Power regression intermediate values:', {
                        validPoints: n,
                        sumXY,
                        sumX,
                        sumY,
                        sumX2
                    });
                    
                    return [a, b]; // returns [a, b] for y = ax^b
                };

                // Generate curve data points
                const numPoints = 100;
                const xMin = d3.min(cars, d => d.mileage);
                const xMax = d3.max(cars, d => d.mileage);
                const xStep = (xMax - xMin) / (numPoints - 1);

                // Calculate moving average
                const movingAverageData = [];
                const sortedForMA = [...cars].sort((a, b) => a.mileage - b.mileage);
                const windowSize = 5;
                
                for (let i = 0; i < numPoints; i++) {
                    const t = i / (numPoints - 1);
                    const index = Math.floor(t * (sortedForMA.length - 1));
                    const start = Math.max(0, index - windowSize);
                    const end = Math.min(sortedForMA.length - 1, index + windowSize);
                    const window = sortedForMA.slice(start, end + 1);
                    const avgMileage = d3.mean(window, d => d.mileage);
                    const avgPrice = d3.mean(window, d => d.price);
                    movingAverageData.push([avgMileage, avgPrice]);
                }

                // Generate exponential curve data
                const [expA, expB] = expRegression();
                const expCurveData = [];
                for (let i = 0; i < numPoints; i++) {
                    const x = xMin + i * xStep;
                    const y = expA * Math.exp(expB * x);
                    expCurveData.push([x, y]);
                }

                // Generate power curve data
                const [powerA, powerB] = powerRegression();
                const powerCurveData = [];
                console.log('Power regression coefficients:', {a: powerA, b: powerB});
                
                // Use a reasonable starting point for the curve
                const minX = Math.max(100, xMin); // Start from 100 km to avoid extreme values
                
                try {
                    for (let i = 0; i < numPoints; i++) {
                        const x = minX + (i / (numPoints - 1)) * (xMax - minX);
                        const y = powerA * Math.pow(x, powerB);
                        if (!isNaN(y) && isFinite(y) && y > 0 && y <= d3.max(cars, d => d.price)) {
                            powerCurveData.push([x, y]);
                        }
                    }
                    console.log('Power curve points generated:', powerCurveData.length);
                    console.log('Power curve sample points:', powerCurveData.slice(0, 5));
                } catch (error) {
                    console.error('Error generating power curve:', error);
                }

                // Create line generator
                const line = d3.line()
                    .x(d => x(d[0]))
                    .y(d => y(d[1]))
                    .curve(d3.curveBasis);

                // Draw all curves
                const curves = [
                    { data: curveData, color: "red", dash: "5,5", name: "Polynomial", class: "polynomial" },
                    { data: movingAverageData, color: "blue", dash: null, name: "Moving Average", class: "moving-average" },
                    { data: expCurveData, color: "green", dash: "3,3", name: "Exponential", class: "exponential" },
                    { data: powerCurveData, color: "purple", dash: "7,3", name: "Power", class: "power" }
                ];

                curves.forEach(curve => {
                    svg.append("path")
                        .datum(curve.data)
                        .attr("class", curve.class)
                        .attr("fill", "none")
                        .attr("stroke", curve.color)
                        .attr("stroke-width", 2.5)
                        .attr("stroke-dasharray", curve.dash)
                        .attr("d", line)
                        .style("opacity", 0.7);
                });

                // Add legend
                const legend = svg.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(${width - 150}, 20)`);

                curves.forEach((curve, i) => {
                    legend.append("line")
                        .attr("x1", 0)
                        .attr("x2", 20)
                        .attr("y1", i * 20)
                        .attr("y2", i * 20)
                        .attr("stroke", curve.color)
                        .attr("stroke-width", 2.5)
                        .attr("stroke-dasharray", curve.dash);

                    legend.append("text")
                        .attr("x", 25)
                        .attr("y", i * 20 + 4)
                        .text(curve.name)
                        .style("font-size", "12px");
                });

                // Add title
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", -margin.top / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "16px")
                    .style("font-weight", "bold")
                    .text("Car Price vs Mileage");
            })
            .catch(error => console.error('Error loading the data:', error));
        });
    </script>
</body>
</html>
